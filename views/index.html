<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A cool thing made with Glitch">

    <title>Test Okta Signin Widget</title>

    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">
    
    <script src="https://global.oktacdn.com/okta-signin-widget/4.1.1/js/okta-sign-in.min.js" type="text/javascript"></script>

    <link href="https://global.oktacdn.com/okta-signin-widget/4.1.1/css/okta-sign-in.min.css" type="text/css" rel="stylesheet"/>
    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
    <div id="greeting"></div>
    <div id="logout" style="display:none">
      <a href="javascript:;" onclick="logout();">Logout</a>
    </div>
    <div id="api" style="display:none">
      <button onclick="callApi()">Call API</button>
      <textarea id="apiresponse" name="apiresponse" rows="4" cols="50">
      </textarea>
    </div>
    <div id="okta-login-container"></div> 
        <script type="text/javascript">
          var signIn = new OktaSignIn({
            baseUrl : 'https://sathishb.okta.com',
            clientId : '0oaafj1e3jBIA1FSE2p7',
            redirectUri : 'https://sathish-widget.glitch.me',
            authParams : {                  
              issuer: 'https://sathishb.okta.com/oauth2/default',
              pkce: false,
              //display: 'page',
              //responseType: 'code',
              responseType: ['id_token', 'token'],
              // `display: page` will initiate the OAuth2 page redirect flow
              scopes : [  'openid','email','profile','address','phone']
            },              
            features : {
              registration : true,
              rememberMe : false,
              smsRecovery : true,
              multiOptionalFactorEnroll : true,
              selfServiceUnlock : true,
              autoPush : true,
              idpDiscovery: false
            }
          });

          signIn.authClient.session.exists()
          .then(function(exists) {
            if (exists) {
              //alert('Session exists');
              signIn.authClient.token.getUserInfo()
                .then(function(user) {
                  //alert('In get User');
                  document.getElementById("greeting").style.display = 'block';
                  document.getElementById("greeting").innerHTML = 'Welcome ' + user.given_name + '!';
                  document.getElementById("logout").style.display = 'block';
                  document.getElementById("api").style.display = 'block';
                })
                .catch(function(err) {
                  // handle OAuthError or AuthSdkError (AuthSdkError will be thrown if app is in OAuthCallback state)
                });
              } else {
                //alert('Session exists but no code/tokens found');
                signIn.renderEl({el: '#okta-login-container'},
                  function success(res) {
                    //alert("In Success");
                    signIn.authClient.tokenManager.add('idToken', res.tokens.idToken);
                    signIn.authClient.tokenManager.add('accessToken', res.tokens.accessToken);
                    window.location.assign(window.location.protocol + '//' + window.location.hostname);
                });
              }
            } 
          );
          
          function logout()
          {
              signIn.authClient.signOut();
          }
          
          async function callApi()
          {
              const accessToken = await signIn.authClient.tokenManager.get('accessToken');
              if (!accessToken) {
                // This means that the user is not logged in
                return;
              }
              // Make a request using jQuery
              $.ajax({
                // Your API or resource server:
                url: window.location.protocol + '//' + window.location.hostname + '/api',
                headers: {
                  Authorization: 'Bearer ' + accessToken.accessToken
                },
                success: function(response) {
                  // Received messages!
                  document.getElementById("apiresponse").innerHTML = response.status;
                },
                error: function(response) {
                  document.getElementById("apiresponse").innerHTML = response.status;
                }
              });
          }
      </script>
  </body>
</html>
